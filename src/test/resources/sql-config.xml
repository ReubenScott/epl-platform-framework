<?xml version="1.0" encoding="UTF-8"?>

<sql>




  <sql-info>
    <sql-name>零售客户信息</sql-name>
    <sql-value><![CDATA[
        select T1.CI_CHN_NAME AS 客户名称
              ,T1.CI_CUST_NO AS 客户编号
              , CASE T1.CI_SEX WHEN '1' THEN    'm' WHEN '2' THEN 'f' ELSE T1.CI_SEX END    AS 性别
              , CASE WHEN  T1.CI_RES_CNTY in ( '156' ,'X' ) THEN 'CHN'ELSE T1.CI_RES_CNTY END    AS 国籍
              ,T1.CI_CUST_TYP AS 客户类别
              ,T1.CI_OCCUP_COD  AS 职业
              ,T3.CI_ADDR  AS 住址
              ,T3.CI_MOBILE_PHONE  AS 移动电话
              , CASE T2.EC_CER_TYP
                  WHEN '0' THEN        '1'
                  WHEN '1' THEN        '2'
                  WHEN '105' THEN      '99'
                  WHEN '106' THEN      '99'
                  WHEN '2001' THEN     '99'
                  WHEN '21' THEN       '3'
                  WHEN '22' THEN       '3'
                  WHEN '3' THEN        '4'
                  WHEN '4' THEN        '4'
                  WHEN '5' THEN        '99'
                  WHEN '6' THEN        '99'
                  WHEN 'X' THEN        '99'
                ELSE T2.EC_CER_TYP END AS 客户证件类型
              ,T2.EC_CER_NO AS 客户证件号码
              ,T1.CI_WOKG_UNIT_NAME AS 工作单位
        from F_CI_CICIFCIF T1
           left join F_CI_ECCIFIDI T2
             on T1.CI_CUST_NO = T2.EC_CUST_NO and T2.EC_PRI_CER_FLG = 'Y'     -- 主证件号
           left join  F_CI_CICIFADR T3
             on T1.CI_CUST_NO  = T3.FK_CICIF_KEY
          where  T1.CI_CUST_TYP = 1    -- 客户类别
       ]]>
    </sql-value>
  </sql-info>

  <sql-info>
    <sql-name>对公客户信息</sql-name>
    <sql-value><![CDATA[
      select T1.CI_CHN_NAME AS 企业名称
            ,T1.CI_CUST_NO AS 企业编号
            ,T2.EC_CER_TYP  AS 企业证件类型
            ,T2.EC_CER_NO AS 企业证件号码
            ,T4.EC_FULL_NAM  AS 法人姓名      
            ,CASE T4.EC_CER_TYP
                WHEN '0' THEN       '1'
                WHEN '1' THEN       '2'
                WHEN '105' THEN     '99'
                WHEN '106' THEN     '99'
                WHEN '2001' THEN    '99'
                WHEN '21' THEN      '3'
                WHEN '22' THEN      '3'
                WHEN '3' THEN       '4'
                WHEN '4' THEN       '4'
                WHEN '5' THEN       '99'
                WHEN '6' THEN       '99'
                WHEN 'X' THEN       '99'
              ELSE T2.EC_CER_TYP END AS 法人证件类型        
            ,T4.EC_CER_NO  AS 法人证件号码
            ,''  AS 上级
      from F_CI_CICIECIF T1
         left join F_CI_ECCIFIDI T2
           on T1.CI_CUST_NO = T2.EC_CUST_NO and T2.EC_PRI_CER_FLG = 'Y'   -- 主证件号
         left join F_CI_ECCIFCCR T3 
           on T1.CI_CUST_NO   = T3.EC_CUST_ID_A  and T3.EC_REL_TYP = '01'   -- 企业法人
         left join F_CI_ECCIFIDI T4
           on T3.EC_CUST_ID_B = T4.EC_CUST_NO and T4.EC_PRI_CER_FLG = 'Y'   -- 主证件号
        where  T1.CI_CUST_TYP = 2  -- 客户类别
          and T1.CI_CUST_NO not in (      
              -- 个体工商户贷款
              SELECT custid  
              FROM EDW.S_LN_XDBL_ACCOUNT_D T1   
              WHERE STATDATE = '2017-04-30'
                AND LEFT(T1.CUSTID, 1) = '2'
                AND T1.INDUSTRYPRO = '12'
                AND LEFT(T1.ITEMCODE, 4) = '1303'     -- 个体工商户 科目入在 农村企业贷款
          
              union all
                      
              select CLTNBR from edw.S_DEP_SA_ACCOUNT_D
                where STATDATE = '2017-04-30'
                  and itemcode in (
                    -- 个体工商户
                    select subjcode from edw.F_CM_GL_CW_KM 
                      where subjname like '%个体工商户%'
                        and left(subjcode,1) = '2'
                        and length(subjcode) = 8    
                  )
    
              union all
    
              select CLTNBR from edw.S_DEP_TD_ACCOUNT_D
                where STATDATE = '2017-04-30'
                  and itemcode in (
                    -- 个体工商户
                    select subjcode from edw.F_CM_GL_CW_KM 
                      where subjname like '%个体工商户%'
                        and left(subjcode,1) = '2'
                        and length(subjcode) = 8    
                  )
            )
       ]]>
    </sql-value>
  </sql-info>


  <sql-info>
    <sql-name>个体工商户</sql-name>
    <sql-value><![CDATA[      
      select T1.CI_CHN_NAME AS 企业名称
            ,T1.CI_CUST_NO AS 企业编号
            ,T4.EC_FULL_NAM  AS 法人姓名      
            ,CASE T4.EC_CER_TYP
                WHEN '0' THEN       '1'
                WHEN '1' THEN       '2'
                WHEN '105' THEN     '99'
                WHEN '106' THEN     '99'
                WHEN '2001' THEN    '99'
                WHEN '21' THEN      '3'
                WHEN '22' THEN      '3'
                WHEN '3' THEN       '4'
                WHEN '4' THEN       '4'
                WHEN '5' THEN       '99'
                WHEN '6' THEN       '99'
                WHEN 'X' THEN       '99'
              ELSE T2.EC_CER_TYP END AS 法人证件类型        
            ,T4.EC_CER_NO  AS 法人证件号码
      from F_CI_CICIECIF T1
         left join F_CI_ECCIFIDI T2
           on T1.CI_CUST_NO = T2.EC_CUST_NO and T2.EC_PRI_CER_FLG = 'Y'   -- 主证件号
         left join F_CI_ECCIFCCR T3 
           on T1.CI_CUST_NO   = T3.EC_CUST_ID_A  and T3.EC_REL_TYP = '01'   -- 企业法人
         left join F_CI_ECCIFIDI T4
           on T3.EC_CUST_ID_B = T4.EC_CUST_NO and T4.EC_PRI_CER_FLG = 'Y'   -- 主证件号
        where  T1.CI_CUST_TYP = 2  -- 客户类别
          and T1.CI_CUST_NO in (      
            -- 个体工商户贷款
            SELECT custid  
            FROM EDW.S_LN_XDBL_ACCOUNT_D T1   
            WHERE STATDATE = '2017-04-30'
              AND LEFT(T1.CUSTID, 1) = '2'
              AND T1.INDUSTRYPRO = '12'
              AND LEFT(T1.ITEMCODE, 4) = '1303'     -- 个体工商户 科目入在 农村企业贷款
        
            union all
                    
            select CLTNBR from edw.S_DEP_SA_ACCOUNT_D
              where STATDATE = '2017-04-30'
                and itemcode in (
                  -- 个体工商户
                  select subjcode from edw.F_CM_GL_CW_KM 
                    where subjname like '%个体工商户%'
                      and left(subjcode,1) = '2'
                      and length(subjcode) = 8    
                )
  
            union all
  
            select CLTNBR from edw.S_DEP_TD_ACCOUNT_D
              where STATDATE = '2017-04-30'
                and itemcode in (
                  -- 个体工商户
                  select subjcode from edw.F_CM_GL_CW_KM 
                    where subjname like '%个体工商户%'
                      and left(subjcode,1) = '2'
                      and length(subjcode) = 8    
                )
          )
       ]]>
    </sql-value>
  </sql-info>




  <sql-info>
    <sql-name>证件</sql-name>
    <sql-value><![CDATA[
          select 
             REPLACE(T1.sjrq,'-','') AS 数据日期
            ,T1.xh As 序号
            ,CASE WHEN T1.khxm = '' THEN '0' ELSE T1.khxm END As 客户名称
            ,CASE WHEN T1.khh = '' THEN '0' ELSE T1.khh END As 客户号
            ,T1.kmh AS 科目,
            T1.kmmc As 科目名称,
            T1.ckzh AS 帐号,
            0  AS 计息标识,
            CASE T1.bz WHEN '01' THEN 'CNY' WHEN '14' THEN 'USD' ELSE T1.bz END AS 币种 ,
            T1.ckye AS 余额
            ,0 AS 积数
            ,0 AS 利息
            ,0 AS 计息天数
            ,T1.ll AS 应付利息
            ,T1.ckye + T1.ll AS 本息合计 
          from sche.qd1 T1
           left join (     
              select  EC_CUST_NO ,  min(EC_CER_TYP) AS EC_CER_TYP , MAX(EC_CER_NO) AS EC_CER_NO
                from (      
                  select EC_CUST_NO ,  EC_CER_TYP  ,EC_CER_NO 
                    from F_CI_ECCIFIDI
                    where EC_PRI_CER_FLG = 'Y' 
                  
                    union 
                      
                  select SA_CUST_NO,  SA_CERT_TYP , SA_CERT_ID from F_DEP_SAACNACN 
                  
                    union 
                      
                  select TD_CUST_NO,  TD_CERT_TYP , TD_CERT_ID from F_DEP_TDACNACN 
              ) group by EC_CUST_NO       
           ) T2 on t1.khh = T2.EC_CUST_NO   
           order by integer(T1.xh) asc 
       ]]>
    </sql-value>
  </sql-info>

  <sql-info>
    <sql-name>每旬理财</sql-name>
    <sql-value><![CDATA[
      SELECT  CUSTTP
           ,COUNT(CASE WHEN APPLAMT <= 500000 THEN IDNO ELSE NULL END)
           ,SUM(CASE WHEN APPLAMT <= 500000 THEN APPLAMT ELSE 0 END)
           ,COUNT(CASE WHEN APPLAMT > 500000 THEN IDNO ELSE NULL END)
           ,SUM(CASE WHEN APPLAMT > 500000 THEN APPLAMT ELSE 0 END)
      FROM (
            SELECT CUSTTP,IDNO,SUM(cast(char(APPLAMT) as bigint))/100  AS APPLAMT
              FROM EDW.F_FIN_SALEINFO
             WHERE PRODSDATE <= '@date'
               AND PRODEDATE > '@date'
               AND REMVFLAG = '0'
               AND BACKFLAG = '0'
               AND CUSTSTATE = '1'
             GROUP BY CUSTTP,IDNO
           )
      GROUP BY CUSTTP
       ]]>
    </sql-value>
  </sql-info>

  <sql-info>
    <sql-name>高管账户余额</sql-name>
    <sql-value><![CDATA[
      SELECT  CLTNM          AS 客户名称
             ,CLTNBR         AS 客户号
             ,SUM(DEPBAL)         AS 账户余额
        FROM (
          SELECT  T1.CARDNBR
                 ,T1.ACCTNBR
                 ,T2.SA_CERT_ID
                 ,T1.CLTNBR
                 ,T1.CLTNM
                 ,T1.OPENDATE
                 ,T1.BRNNBR
                 ,T1.OPENOPERNO
                 ,T1.OPENAMT
                 ,T1.DEPBAL
            FROM EDW.S_DEP_SA_ACCOUNT_D           T1
            LEFT JOIN EDW.F_DEP_SAACNACN  T2
              ON T1.ACCTNBR = T2.SA_ACCT_NO
           WHERE T1.STATDATE = '@date'
             AND T2.SA_CERT_ID IN ('320624196510038072'      --身份证
                ,'432822196602104052'
                ,'320802197502121519'
                ,'320520195808022430'
                ,'320626196312257445'
                ,'32068119840817009X'
                ,'32052519570801067X'
                ,'320525196309075665'
                ,'320626196711140447'
                ,'320626196106170031'
                ,'320626196304134816'
                ,'320626197409269615'
                ,'320626197410233214'
                ,'320626196705054016'
                ,'320681197701241235'
                ,'320625197002125197')     
          
           UNION ALL
          SELECT  ''
                 ,T1.ACCTNBR
                 ,T2.TD_CERT_ID
                 ,T1.CLTNBR
                 ,T1.CLTNM
                 ,T1.OPENDATE
                 ,T1.BRNNBR
                 ,T1.OPENOPERNO
                 ,T1.OPENAMT
                 ,T1.DEPBAL
            FROM EDW.S_DEP_TD_ACCOUNT_D           T1
            LEFT JOIN EDW.F_DEP_TDACNACN  T2
              ON T1.ACCTNBR = T2.TD_TD_ACCT_NO
           WHERE T1.STATDATE = '@date'
             AND T2.TD_CERT_ID IN ('320624196510038072'      --身份证
              ,'432822196602104052'
              ,'320802197502121519'
              ,'320520195808022430'
              ,'320626196312257445'
              ,'32068119840817009X'
              ,'32052519570801067X'
              ,'320525196309075665'
              ,'320626196711140447'
              ,'320626196106170031'
              ,'320626196304134816'
              ,'320626197409269615'
              ,'320626197410233214'
              ,'320626196705054016'
              ,'320681197701241235'
              ,'320625197002125197')      
                   )
             GROUP BY  CLTNBR,CLTNM
        ]]>
    </sql-value>
  </sql-info>

  <sql-info>
    <sql-name>高管活期积数, 余额</sql-name>
    <sql-value><![CDATA[
      SELECT  A.SA_ACCT_NO
             ,A.SA_CUST_NO
             ,SUM(CASE WHEN H.ENDDATE<= '@endDate'
                        AND H.STARTDATE> '@startDate'  THEN (DAYS(DATE(H.ENDDATE))-DAYS(DATE(H.STARTDATE)))*H.DEPBAL
                       WHEN H.ENDDATE> '@endDate'
                        AND H.STARTDATE> '@startDate'  THEN (DAYS(DATE('@endDate'))-DAYS(DATE(H.STARTDATE))+1)*H.DEPBAL
                       WHEN H.ENDDATE> '@endDate'
                        AND H.STARTDATE<= '@startDate'  THEN (DAYS(DATE('@endDate'))-DAYS(DATE('@startDate')))*H.DEPBAL
                       WHEN H.ENDDATE<= '@endDate'
                        AND H.STARTDATE<= '@startDate'  THEN (DAYS(DATE(H.ENDDATE))-DAYS(DATE('@startDate'))-1)*H.DEPBAL
                       ELSE 0
                  END) as 活期积数
               ,SUM(CASE WHEN H.STARTDATE<= '@endDate' and H.ENDDATE> '@endDate' THEN H.DEPBAL ELSE 0 END)  as  活期余额
        FROM F_DEP_SAACNACN                   A
       INNER JOIN S_DEP_SA_ACCOUNT_HIS        H
          ON A.SA_ACCT_NO=H.ACCTNBR
         AND H.ENDDATE> '@startDate'
         AND H.STARTDATE<= '@endDate'
         AND A.SA_CERT_ID IN ('320624196510038072'
                             ,'432822196602104052'
                             ,'320802197502121519'
                             ,'320520195808022430'
                             ,'320626196312257445'
                             ,'32068119840817009X'
                             ,'32052519570801067X'
                             ,'320525196309075665'
                             ,'320626196711140447'
                             ,'320626196106170031'
                             ,'320626196304134816'
                             ,'320626197409269615'
                             ,'320626197410233214'
                             ,'320626196705054016'
                             ,'320681197701241235'
                             ,'320625197002125197')
       GROUP BY  A.SA_ACCT_NO,A.SA_CUST_NO
       HAVING SUM(CASE WHEN H.ENDDATE<= '@endDate'
                        AND H.STARTDATE> '@startDate'  THEN (DAYS(DATE(H.ENDDATE))-DAYS(DATE(H.STARTDATE)))*H.DEPBAL
                       WHEN H.ENDDATE> '@endDate'
                        AND H.STARTDATE> '@startDate'  THEN (DAYS(DATE('@endDate'))-DAYS(DATE(H.STARTDATE))+1)*H.DEPBAL
                       WHEN H.ENDDATE> '@endDate'
                        AND H.STARTDATE<= '@startDate'  THEN (DAYS(DATE('@endDate'))-DAYS(DATE('@startDate')))*H.DEPBAL
                       WHEN H.ENDDATE<= '@endDate'
                        AND H.STARTDATE<= '@startDate'  THEN (DAYS(DATE(H.ENDDATE))-DAYS(DATE('@startDate'))-1)*H.DEPBAL
                       ELSE 0
                  END) >0 
       ORDER BY 3 asc        
        ]]>
    </sql-value>
  </sql-info>

  <sql-info>
    <sql-name>出货</sql-name>
    <sql-value><![CDATA[

     ]]>
    </sql-value>
  </sql-info>

</sql>